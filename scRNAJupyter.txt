
#Packages to install
import scanpy as sc
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import anndata as ad
import pooch
import os
import h5py
import igraph
import leidenalg
import seaborn as sns # not needed



# Read data files
Ctrl1 = sc.read_10x_h5("/Users/25advaym/genomics/GLPvsSAL/Ctrl1/Ctrl1.h5")
Ctrl2 = sc.read_10x_h5("/Users/25advaym/genomics/GLPvsSAL/Ctrl2/Ctrl2.h5")
Obese1 = sc.read_10x_h5("/Users/25advaym/genomics/GLPvsSAL/Obese1/Obese1.h5")
Obese2 = sc.read_10x_h5("/Users/25advaym/genomics/GLPvsSAL/Obese2/Obese2.h5")


# Make variable names unique across datasets
for data in [Ctrl1, Ctrl2, Obese1, Obese2]:
    data.var_names_make_unique()
    data.obs_names_make_unique()





# Concatenate the datasets
merged = ad.concat(
    [Ctrl1, Ctrl2, Obese1, Obese2],
    label='sample',  # New column name for sample origin
    keys=['Ctrl1', 'Ctrl2', 'Obese1', 'Obese2'],  # Values for the sample column
    join='outer',  # Join type (union of genes)
    index_unique=None  # Keep original index if possible
)

merged.var_names_make_unique()
merged.obs_names_make_unique()

# Check the merged data
print(merged)

sc.pp.filter_cells(merged, min_genes=200)
sc.pp.filter_genes(merged, min_cells=3)

# mitochondrial genes, "MT-" for human, "Mt-" for mouse
merged.var["mt"] = merged.var_names.str.startswith("mt")
# ribosomal genes
merged.var["ribo"] = merged.var_names.str.startswith(("Rps", "Rpl"))

# Create a combined mask for mitochondrial and ribosomal genes
exclude_genes_mask = merged.var["mt"] | merged.var["ribo"]

# Reassign merged to exclude these genes
merged = merged[:, ~exclude_genes_mask]



sig_genes = sc.pl.highest_expr_genes(merged, n_top=20)






# Quality control
sc.pp.calculate_qc_metrics(
    merged, qc_vars=["mt", "ribo"], inplace=True, log1p=True
)

# Violin Plot of data
sc.pl.violin(
    merged,
    ["n_genes_by_counts", "total_counts", "pct_counts_mt"],
    jitter=0.4,
    multi_panel=True,
)











# Clustering and UMAP
sc.pp.scale(merged, max_value=10)
sc.tl.pca(merged, svd_solver='arpack')
sc.pp.neighbors(merged, n_neighbors=10, n_pcs=40)
sc.tl.umap(merged)
sc.tl.leiden(merged, resolution=0.2)


# Feature Plots
sc.pl.umap(merged, color=['leiden', 'S100a8'])
sc.pl.umap(merged, color=['leiden', 'S100a9'])
sc.pl.umap(merged, color=['leiden', 'Ly6g'])
sc.pl.umap(merged, color=['leiden', 'Gapdh'])





# Differential Expression
sc.tl.rank_genes_groups(merged, 'leiden', method='wilcoxon')
sc.pl.rank_genes_groups(merged, n_genes=25, sharey=False)


# Store the results of the Differential Expression

# Extract the DE results into a DataFrame
de_results = pd.DataFrame(
    {group: merged.uns['rank_genes_groups']['names'][group] for group in merged.uns['rank_genes_groups']['names'].dtype.names}
)

output_dir = "/Users/25advaym/genomics"
# Save the results to a CSV file for further analysis or reporting
de_results.to_csv(os.path.join(output_dir, 'differential_expression_results.csv'))








# Visualize Data by cluster
sc.tl.dendrogram(merged, groupby='leiden')
sc.pl.rank_genes_groups_dotplot(merged, n_genes=5, groupby='leiden')
sc.pl.rank_genes_groups_heatmap(merged, n_genes=5, groupby='leiden',show_gene_labels=True)







# I was trying something else here to subset the neutrophils but did not end up finishing it

merged_neu = merged[merged.obs['leiden'] == '9'].copy()

sc.pp.scale(merged, max_value=10)
sc.tl.pca(merged, svd_solver='arpack')
sc.pp.neighbors(merged, n_neighbors=10, n_pcs=40)
sc.tl.umap(merged)
sc.tl.leiden(merged, resolution=0.2)

sc.tl.rank_genes_groups(merged_neu, 'sample', method='wilcoxon')
sc.pl.rank_genes_groups(merged_neu, n_genes=25, sharey=False)

sc.tl.dendrogram(merged_neu, groupby='sample')

sc.pl.rank_genes_groups_dotplot(merged_neu, n_genes=5, groupby='sample')

sc.pl.rank_genes_groups_heatmap(merged_neu, n_genes=5, groupby='sample',show_gene_labels=True)